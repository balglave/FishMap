---
title: "flat_main.Rmd"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

```{r message=FALSE}
library(dplyr)
library(INLA)
library(ggplot2)
library(sf)
library(stringr)
library(tidyr)
library(TMB)
library(tictoc)
library(testthat)
```

# `main.R`

This vignette runs a toy example of the FishMap spatio-temporal model. The execution comprises three steps : data preparation, model fitting and graph generation.

## part1: Data preparation

# fm_load_data

This function Prepare all the necessary output for the model fitting. It will filter and shape the observation data (VMS and scientific). It will generate the spatial mesh for the study domain. All outputs are reported as part of a named list.
    
```{r function-fm_load_data}
#' Load and prepare data for model fitting
#'
#' @param species character Name of the species of interest, match the data folder name
#' @param fleet character Vector of conditional operation to filter fleets, the first one will be taken as reference level in the model
#' @param survey_data_file character Name of the Rdata file storing scientific observations
#' @param vmslogbook_data_file  character Name of the Rdata file storing vms x logbooks observations
#' @param study_domain_file  character Name of the Rdata file storing study domain informations
#' @param year_start integer Lower bound year filter to select data
#' @param year_end integer Upper bound year filter to select data
#' @param month_start integer Lower bound month filter to select data
#' @param month_end integer Upper bound month filter to select data
#' @param time_step character Time intervals, must be Month or Quarter 
#'
#' @importFrom dplyr ungroup select filter arrange mutate
#' @importFrom stringr str_detect
#' @importFrom tictoc tic toc
# source domain_mesh_spde
#' @importFrom dplyr mutate select
#' @importFrom INLA inla.nonconvex.hull inla.mesh.2d inla.CRS inla.spde2.matern inla.mesh.create inla.spde.make.A
#' @importFrom sf st_as_sf st_intersects st_join st_coordinates
#' @importFrom sp SpatialPointsDataFrame CRS
# source shape_sci_data
#' @importFrom dplyr mutate inner_join ungroup select
#' @importFrom INLA inla.spde.make.A
#' @importFrom sf st_as_sf st_intersects st_join st_coordinates
# source shape_vms_logbook
#' @importFrom dplyr inner_join mutate select filter group_by count arrange full_join ungroup
#' @importFrom INLA inla.spde.make.A
#' @importFrom sf st_as_sf st_intersects st_join st_coordinates
#' @importFrom tidyr pivot_wider


#' @return list A named list of all necessary outputs for model fitting (step 2)
#' @export
#'
#' @examples
fm_load_data <- function(species = "Solea_solea",
                         fleet = c("OTB_DEF_>=70_0","OTB_CEP_>=70_0","OTT_DEF_>=70_0"),
                         survey_data_file = "survey_data.Rdata",
                         vmslogbook_data_file = "vmslogbook_data.Rdata",
                         study_domain_file = "study_domain.Rdata",
                         year_start = 2018,
                         year_end = 2018,
                         month_start = 11,
                         month_end = 11,
                         time_step = "Month"
                         ) {
  ## Load data
  #-----------
  message("Running step 1 -loading data-")
  tictoc::tic("Step 1 -loading data-")
  
  data_folder <- system.file(file.path("original_data",species), package = "FishMap") 
  script_folder <- system.file("original_scripts", package = "FishMap") 
  
  fitted_data <- "biomass" # "biomass" "presabs"
  
  # Scientific data
  n_survey <- 1 # number of surveys
  load(file.path(data_folder,survey_data_file))
  scientific_observation <- "CPUE" # 'CPUE' or 'Density'
  survey_data_0 <- survey_data %>% ungroup %>% dplyr::select(-layer)
  
  # 'VMS x logbook' data
  load(file.path(data_folder,vmslogbook_data_file))
  
  select_aggreg_level <- paste(fleet,collapse = "|")
  vmslogbook_data <- vmslogbook_data %>%
    filter(str_detect(LE_MET_level6,select_aggreg_level))
  
  vmslogbook_data$LE_MET_level6 <- factor(as.character(vmslogbook_data$LE_MET_level6),levels = fleet)
  
  vmslogbook_data_0 <- vmslogbook_data %>% ungroup %>% dplyr::select(-layer)
  
  ## Time series
  #-------------
  year_vec <- year_start:year_end
  month_vec <- month_start:month_end

  if(time_step == "Month"){
  
    time.step_df <- expand.grid(month_vec,year_vec)
    colnames(time.step_df) <- c("Month","Year")
  
    time.step_df <- time.step_df %>%
      arrange(Year,Month) %>%
      mutate(Month = ifelse(Month < 10,paste0("0",Month),Month)) %>%
      mutate(Year_Month = paste0(Year,"_",Month)) %>%
      mutate(t = 1:nrow(time.step_df))
    time.step_df$Year <- as.character(time.step_df$Year)
    time.step_df$Month <- as.character(time.step_df$Month)
  
  }else if(time_step == "Quarter"){
  
    time.step_df <- expand.grid(1:4,all_years)
    colnames(time.step_df) <- c("Quarter","Year")
  
    time.step_df <- time.step_df %>%
      arrange(Year,Quarter) %>%
      mutate(Quarter = ifelse(Quarter < 10,paste0("0",Quarter),Quarter)) %>%
      mutate(Year_Quarter = paste0(Year,"_",Quarter)) %>%
      mutate(t = 1:nrow(time.step_df))
    time.step_df$Year <- as.character(time.step_df$Year)
    time.step_df$Quarter <- as.character(time.step_df$Quarter)
  
  }
  
  
  ## Configure spatial domain
  #--------------------------
  grid_xmin <- -6
  grid_xmax <- 0
  grid_ymin <- 42
  grid_ymax <- 48
  grid_limit <- raster::extent(c(grid_xmin,grid_xmax,grid_ymin,grid_ymax))
  
  grid_projection <- "+proj=longlat +datum=WGS84"
  
  resol <- 0.05 # resolution of the discretization grid
  create_mesh <- "from_shapefile"
  # from_shapefile: the mesh will be more regular on the grid
  # from_data: the mesh will be denser in the areas where there are data
  
  # Mesh parameterization
  # reduce the mesh size (k = 0.25 now) reduces the number of knots at which the spatial random effect is computed.
  k <- 0.25
  Alpha <- 2
  
  load(file.path(data_folder,study_domain_file))
  
  ## Load domain / mesh / spde object
  source(file.path(script_folder,"domain_mesh_spde.R"), local=TRUE)
  
  ## Shape scientific data
  source(file.path(script_folder,"shape_sci_data_st.R"), local=TRUE)
  
  ## Shape commercial data
  source(file.path(script_folder,"shape_vmslogbook_data_st.R"), local=TRUE)
  
  if(fitted_data=="presabs"){
    y_com_i[which(y_com_i > 0)] <- 1
    y_sci_i[which(y_sci_i > 0)] <- 1
    lf_link <- 1 # logit link
  }
  
  
  ## Covariates
  #------------
  # load(file.path(data_folder,"bathy_pred.Rdata"))
  bathy_pred = rep(0,nrow(loc_x))
  cov_x_pred <- matrix(data = bathy_pred, ncol = 1)
  
  # load(file.path(data_folder,"bathy_com.Rdata"))
  bathy_com = rep(0,nrow(vmslogbook_data_2))
  cov_x_com <- matrix(data = bathy_com, ncol = 1)
  
  # load(file.path(data_folder,"bathy_sci.Rdata"))
  bathy_sci = rep(0,nrow(survey_data_2))
  cov_x_sci <- matrix(data = bathy_sci, ncol = 1)

  # finished step 1 -loading data-
  toc()

  # return outputs as names list
  return(list("b_com_i" = b_com_i,
              "mesh" = mesh,
              "time.step_df" = time.step_df,
              "loc_x" = loc_x,
              "y_com_i" = y_com_i,
              "y_sci_i" = y_sci_i,
              "cov_x_com" = cov_x_com,
              "cov_x_sci" = cov_x_sci,
              "c_com_x" = c_com_x,
              "t_com_i" = t_com_i,
              "t_sci_i" = t_sci_i,
              "spde" = spde,
              "Aix_ij_com" = Aix_ij_com,
              "Aix_w_com" = Aix_w_com,
              "Aix_ij_sci" = Aix_ij_sci,
              "Aix_w_sci" = Aix_w_sci,
              "cov_x_pred"=cov_x_pred,
              "Aix_ij_pred"=Aix_ij_pred,
              "Aix_w_pred"=Aix_w_pred,
              "W"=W,
              "n_survey" = n_survey,
              "MeshList_aniso" = MeshList_aniso
              ))
}
```
  
```{r example-fm_load_data}
# run part1
fm_data_inputs <- fm_load_data()

```
  
```{r tests-fm_load_data}
test_that("fm_load_data works", {
  
  # run function
  fm_data_inputs <- fm_load_data()
  
  # save part1 outputs
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    # setup save dir, create it if necessary
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    if (isFALSE(dir.exists(output_dir))){
      dir.create(output_dir)
    }
    # save output
    saveRDS(object = fm_data_inputs, file = file.path(output_dir, "part1_output.rds"))
  }
  
  # check output is a list
  expect_true(object = inherits(x = fm_data_inputs,
                                what = "list"))
  
  # check output is saved as rds
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    expect_true(file.exists(file.path(output_dir, "part1_output.rds")))
  }
  
})
```

## part2: fit model

```{r}
## Fit model
#-----------
message("Running step 2 -compile model-")
tic("Step 2 -compile model-")

## Dependencies from Part1 factorization
species = "Solea_solea"
data_folder <- system.file(file.path("original_data",species), package = "FishMap") 
script_folder <- system.file("original_scripts", package = "FishMap")
b_com_i <- fm_data_inputs[["b_com_i"]]
mesh <- fm_data_inputs[["mesh"]]
time.step_df <- fm_data_inputs[["time.step_df"]]
loc_x <- fm_data_inputs[["loc_x"]]
y_com_i <- fm_data_inputs[["y_com_i"]]
y_sci_i <- fm_data_inputs[["y_sci_i"]]
cov_x_com <- fm_data_inputs[["cov_x_com"]]
cov_x_sci <- fm_data_inputs[["cov_x_sci"]]
c_com_x <- fm_data_inputs[["c_com_x"]]
t_com_i <- fm_data_inputs[["t_com_i"]]
t_sci_i <- fm_data_inputs[["t_sci_i"]]
spde <- fm_data_inputs[["spde"]]
Aix_ij_com <- fm_data_inputs[["Aix_ij_com"]]
Aix_w_com <- fm_data_inputs[["Aix_w_com"]]
Aix_ij_sci <- fm_data_inputs[["Aix_ij_sci"]]
Aix_w_sci <- fm_data_inputs[["Aix_w_sci"]]
cov_x_pred <- fm_data_inputs[["cov_x_pred"]]
Aix_ij_pred <- fm_data_inputs[["Aix_ij_pred"]]
Aix_w_pred <- fm_data_inputs[["Aix_w_pred"]]
W <- fm_data_inputs[["W"]]
n_survey <- fm_data_inputs[["n_survey"]]
MeshList_aniso <- fm_data_inputs[["MeshList_aniso"]]

## Model configuration
SE <- 1 # run ADREPORT - 0: no, 1: yes
data_source <- 1 # 1: integrated model (scientific + commercial data), 2: scientific model, 3: commercial model
data_obs <- 2 # observation model for biomass - 1: zero_inflated gamma, 2: zero-inflated lognormal, 3: lognormal
samp_process <- 0 # Sampling process - 0: no sampling process, 1: inhomogeneous Poisson point process
b_constraint <- 2 # put constraint on b parameters - 1: b are positive, 2: no constraints
const_spphab <- 1 # Species-habitat relationship - 1: constant in time
cov_samp_process <- 0 # covariate in the sampling process - 0: none, 1: covariate in the samplign process
biomass_temporal <- 1 # Account for temporal correlation in biomass - 0: no, 1: AR1
sampling_temporal <- 0 # Account for temporal correlation in sampling process - 0: no, 1: AR1
anisotropy <- 0 # Account for anisotropy
lf_link <- 0 # link function of the latent field - 0: log (biomass data), 1: logit (presence absence data)
ref_data <- "com" # reference data - "com": commercial (default) or "sci": scientific
EM <- "est_b" # "est_b": b is estimated, "fix_b": b is fixed
month_ref <- 1 # reference month (here January)
cov_samp_process <- 0 # 0: no covariate in the sampling process, 1: put covariate in the sampling process
compute_sd <- FALSE

xfb_x <- NULL # TO DELETE
weights_com <- 1 # TO DELETE

## Build Data, Params and Map objects for model fitting
source(file.path(script_folder,"build_data_params_map.R"))

# Add link to path
if (.Platform$OS.type == "windows"){
  fixwinpath <- function(){
    PATH <- Sys.getenv("PATH")
    PATH <- paste0(R.home(), "/bin/x64;", PATH)
    PATH <- paste0("c:/Rtools/mingw64/bin;", PATH)
    Sys.setenv(PATH=PATH)
  }
  fixwinpath()
  shell("where g++")
  shell("where gdb")
  shell("where Rterm")
}

## Model compilation
TMB::compile(system.file("model.cpp", package = "FishMap"),"-O1 -g",DLLFLAGS="")
dyn.load( dynlib(file.path(system.file(package = "FishMap"),"model") ))

# finished step 2 -compile model-
toc()

## Fit model
message("Running step 3 -fit model-")
tic("Step 3 -fit model-")

# ## Debugging
# source("r/function/MakeADFun_windows_debug.R")
# MakeADFun_windows_debug(cpp_name = "inst/model",  data=Data, parameters=Params,  random=Random)
# TMB::gdbsource("inst/model.R",interactive = T) ## Non-interactive
# dyn.unload( dynlib( "inst/model" ) )
# #-----------

obj = MakeADFun( data=Data, parameters=Params,  random=Random, map = Map, silent = TRUE,hessian = TRUE )
# next line takes a long time ----
obj$fn( obj$par )

# Parameters boundary for optimization
Lower <- -50
Upper <- 50

if(T %in% str_detect(names(obj$par),"rho_")){ # constraints on the bounds of rho

  Lower <- rep(-50,length(obj$par))
  Upper <- rep(50,length(obj$par))

  Lower[which(str_detect(names(obj$par),"rho_"))] <- -0.99
  Upper[which(str_detect(names(obj$par),"rho_"))] <- 0.99

}

# next line takes a VERY long time ----
opt = nlminb( start=obj$par, objective=obj$fn, gradient=obj$gr, lower=Lower, upper=Upper, control=list(trace=1, maxit=200))
opt[["diagnostics"]] = data.frame( "Param"=names(obj$par), "Lower"=-Inf, "Est"=opt$par, "Upper"=Inf, "gradient"=obj$gr(opt$par) )

#save intermediate opt
if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
  output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
  saveRDS(object = opt, file = file.path(output_dir, "opt_output.rds"))
  saveRDS(object = obj, file = file.path(output_dir, "obj_input.rds"))
}

report = obj$report() # output values
converge=opt$convergence # convergence test
# next line takes a VERY long time ----
if(compute_sd) SD = sdreport(obj,bias.correct=FALSE,ignore.parm.uncertainty=TRUE) # compute standard deviation

#save intermediate opt
if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
  output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
  saveRDS(object = report, file = file.path(output_dir,"report_output.rds"))
  saveRDS(object = converge, file = file.path(output_dir, "converge_output.rds"))
}

dyn.unload( dynlib( file.path(system.file(package = "FishMap"),"model")))

# Finished step 3 - fit model-
toc()
```

## part3: generate output graphs

```{r}
## Plot model outputs
#--------------------
message("Running step 4 -plot graphs-")
tic("Step 4 -plot graphs-")

if(nrow(time.step_df)>1){

  pred_df <- cbind(loc_x[,c("long","lati")],S_x=report$S_p[1:nrow(loc_x),]) %>%
    pivot_longer(cols = starts_with("S_x."),names_to = "t", values_to = "S_x") %>%
    mutate(t = as.numeric(str_replace(t,"S_x.",""))) %>%
    inner_join(time.step_df)

  pred_sf <- st_as_sf(pred_df,coords = c("long","lati"))

  pred_plot <- ggplot(pred_sf)+
    geom_sf(aes(col=S_x))+
    scale_color_distiller(palette = "Spectral")+
    facet_wrap(.~Year_Month)


}else if(nrow(time.step_df)==1){

  pred_df <- cbind(loc_x[,c("long","lati")],S_x=report$S_p[1:nrow(loc_x),])

  pred_sf <- st_as_sf(pred_df,coords = c("long","lati"))

  pred_plot <- ggplot(pred_sf)+
    geom_sf(aes(col=S_x))+
    scale_color_distiller(palette = "Spectral")

}

plot(pred_plot)

# plot eta if sampling is active
if (samp_process == 1){
  for(i in 1:3){
    eta_df <- cbind(loc_x[,c("long","lati")],eta=report$lambda_p[1:nrow(loc_x),,i]) %>%
      pivot_longer(cols = starts_with("eta."),names_to = "t", values_to = "eta") %>%
      mutate(t = as.numeric(str_replace(t,"eta.",""))) %>%
      inner_join(time.step_df)

    eta_sf <- st_as_sf(eta_df,coords = c("long","lati"))

    eta_plot <- ggplot(eta_sf)+
      geom_sf(aes(col=log(eta)))+
      scale_color_distiller(palette = "Spectral")+
      facet_wrap(.~Year_Month)

    plot(eta_plot)
  }
}

# finished step 4 -plot graph-
toc()
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_main.Rmd", check = FALSE,
               vignette_name = "running fishmap")

# To perform check, please go to `dev/0_dev_history.Rmd` and run the section `Use everytime needed`
```


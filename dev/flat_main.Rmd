---
title: "flat_main.Rmd"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

```{r message=FALSE}
library(dplyr)
library(INLA)
library(ggplot2)
library(sf)
library(stringr)
library(tidyr)
library(TMB)
library(tictoc)
library(testthat)
```

# `main.R`

This vignette runs a toy example of the FishMap spatio-temporal model. The execution comprises three steps : data preparation, model fitting and graph generation.

## part1: Data preparation

### `fm_load_data()` : prepare and load model inputs

This function Prepare all the necessary output for the model fitting. It will filter and shape the observation data (VMS and scientific). It will generate the spatial mesh for the study domain. All outputs are reported as part of a named list.
    
```{r function-fm_load_data}
#' Load and prepare data for model fitting
#'
#' @param species character Species of interest
#' @param fleet character Fleet chosen according to the species of interest. A fleet is considered to have homogeneous catchability and targeting behavior.
#' @param fitted_data character Type of the data to be fitted to the model (either `biomass` for biomass data - positive-continuous data - or `presabs` for presence-absence data). Default is `biomass`
#' @param survey_data_file character File containing the scientific (survey) data
#' @param vmslogbook_data_file  character File containing the commercial (vmslogbook) data
#' @param study_domain_file  character File containing the data describing the study area
#' @param year_start integer Starting year
#' @param year_end integer Ending year
#' @param month_start integer Starting month
#' @param month_end integer Ending month
#' @param time_step character Time step for the model (either `Month` for monthly time step or `Quarter` for quarterly time step). Default is `Month`
#' @param k numeric Parameter controlling the number of knots of the mesh. The higher the denser.
#' @param grid_xmin,grid_xmax,grid_ymin,grid_ymax  numeric Limitation of the grid for the spatial domain
#' @param seed integer The seed controlling for random effect. Default is 29510.
#' 
#' @importFrom dplyr ungroup select filter arrange mutate
#' @importFrom stringr str_detect
#' @importFrom tictoc tic toc
#' @importFrom withr local_seed
# source domain_mesh_spde
#' @importFrom dplyr mutate select
#' @importFrom INLA inla.nonconvex.hull inla.mesh.2d inla.CRS inla.spde2.matern inla.mesh.create inla.spde.make.A
#' @importFrom sf st_as_sf st_intersects st_join st_coordinates
#' @importFrom sp SpatialPointsDataFrame CRS
# source shape_sci_data
#' @importFrom dplyr mutate inner_join ungroup select
#' @importFrom INLA inla.spde.make.A
#' @importFrom sf st_as_sf st_intersects st_join st_coordinates
# source shape_vms_logbook
#' @importFrom dplyr inner_join mutate select filter group_by count arrange full_join ungroup
#' @importFrom INLA inla.spde.make.A
#' @importFrom sf st_as_sf st_intersects st_join st_coordinates
#' @importFrom tidyr pivot_wider
#' 
#' @return list A named list of all necessary outputs for model fitting (step 2)
#' @export
#'
#' @examples
fm_load_data <- function(species,
                         fleet,
                         fitted_data = c("biomass","presabs"),
                         survey_data_file,
                         vmslogbook_data_file,
                         study_domain_file,
                         year_start,
                         year_end,
                         month_start,
                         month_end,
                         time_step = c("Month","Quarter"),
                         k,
                         grid_xmin,
                         grid_xmax,
                         grid_ymin,
                         grid_ymax,
                         seed = 29510
                         ) {
  ## Load data
  #-----------
  message("Running step 1 -loading data-")
  tic("Step 1 -loading data-")
  
  # set seed
  local_seed(seed = seed)
  
  script_folder <- system.file("original_scripts", package = "FishMap") 
  
  fitted_data <- match.arg(fitted_data)
  time_step <- match.arg(time_step)
  
  # Scientific data
  n_survey <- 1 # number of surveys
  load(survey_data_file)
  scientific_observation <- "CPUE" # 'CPUE' or 'Density'
  survey_data_0 <- survey_data %>% ungroup %>% dplyr::select(-layer)
  
  # 'VMS x logbook' data
  load(vmslogbook_data_file)
  
  select_aggreg_level <- paste(fleet,collapse = "|")
  vmslogbook_data <- vmslogbook_data %>%
    filter(str_detect(LE_MET_level6,select_aggreg_level))
  
  vmslogbook_data$LE_MET_level6 <- factor(as.character(vmslogbook_data$LE_MET_level6),levels = fleet)
  
  vmslogbook_data_0 <- vmslogbook_data %>% ungroup %>% dplyr::select(-layer)
  
  ## Time series
  #-------------
  year_vec <- year_start:year_end
  month_vec <- month_start:month_end

  if(time_step == "Month"){
  
    time.step_df <- expand.grid(month_vec,year_vec)
    colnames(time.step_df) <- c("Month","Year")
  
    time.step_df <- time.step_df %>%
      arrange(Year,Month) %>%
      mutate(Month = ifelse(Month < 10,paste0("0",Month),Month)) %>%
      mutate(Year_Month = paste0(Year,"_",Month)) %>%
      mutate(t = 1:nrow(time.step_df))
    time.step_df$Year <- as.character(time.step_df$Year)
    time.step_df$Month <- as.character(time.step_df$Month)
  
  }else if(time_step == "Quarter"){
  
    time.step_df <- expand.grid(1:4,all_years)
    colnames(time.step_df) <- c("Quarter","Year")
  
    time.step_df <- time.step_df %>%
      arrange(Year,Quarter) %>%
      mutate(Quarter = ifelse(Quarter < 10,paste0("0",Quarter),Quarter)) %>%
      mutate(Year_Quarter = paste0(Year,"_",Quarter)) %>%
      mutate(t = 1:nrow(time.step_df))
    time.step_df$Year <- as.character(time.step_df$Year)
    time.step_df$Quarter <- as.character(time.step_df$Quarter)
  
  }
  
  
  ## Configure spatial domain
  #--------------------------
  grid_xmin <- grid_xmin
  grid_xmax <- grid_xmax
  grid_ymin <- grid_ymin
  grid_ymax <- grid_ymax
  
  grid_limit <- raster::extent(
    c(grid_xmin,
      grid_xmax,
      grid_ymin,
      grid_ymax)
  )
  
  grid_projection <- "+proj=longlat +datum=WGS84"
  
  resol <- 0.05 # resolution of the discretization grid
  create_mesh <- "from_shapefile"
  # from_shapefile: the mesh will be more regular on the grid
  # from_data: the mesh will be denser in the areas where there are data
  
  # Mesh parameterization
  # reduce the mesh size (k = 0.25 now) reduces the number of knots at which the spatial random effect is computed.
  k <- k
  Alpha <- 2
  
  load(study_domain_file)
  
  ## Load domain / mesh / spde object
  source(file.path(script_folder,"domain_mesh_spde.R"), local=TRUE)
  
  ## Shape scientific data
  source(file.path(script_folder,"shape_sci_data_st.R"), local=TRUE)
  
  ## Shape commercial data
  source(file.path(script_folder,"shape_vmslogbook_data_st.R"), local=TRUE)
  
  if(fitted_data=="presabs"){
    y_com_i[which(y_com_i > 0)] <- 1
    y_sci_i[which(y_sci_i > 0)] <- 1
    lf_link <- 1 # logit link
  }
  
  
  ## Covariates
  #------------
  # load(file.path(data_folder,"bathy_pred.Rdata"))
  bathy_pred = rep(0,nrow(loc_x))
  cov_x_pred <- matrix(data = bathy_pred, ncol = 1)
  
  # load(file.path(data_folder,"bathy_com.Rdata"))
  bathy_com = rep(0,nrow(vmslogbook_data_2))
  cov_x_com <- matrix(data = bathy_com, ncol = 1)
  
  # load(file.path(data_folder,"bathy_sci.Rdata"))
  bathy_sci = rep(0,nrow(survey_data_2))
  cov_x_sci <- matrix(data = bathy_sci, ncol = 1)

  # finished step 1 -loading data-
  toc()

  # return outputs as named list
  return(list("species" = species,
              "b_com_i" = b_com_i,
              "mesh" = mesh,
              "time.step_df" = time.step_df,
              "loc_x" = loc_x,
              "y_com_i" = y_com_i,
              "y_sci_i" = y_sci_i,
              "cov_x_com" = cov_x_com,
              "cov_x_sci" = cov_x_sci,
              "c_com_x" = c_com_x,
              "t_com_i" = t_com_i,
              "t_sci_i" = t_sci_i,
              "spde" = spde,
              "Aix_ij_com" = Aix_ij_com,
              "Aix_w_com" = Aix_w_com,
              "Aix_ij_sci" = Aix_ij_sci,
              "Aix_w_sci" = Aix_w_sci,
              "cov_x_pred"=cov_x_pred,
              "Aix_ij_pred"=Aix_ij_pred,
              "Aix_w_pred"=Aix_w_pred,
              "W"=W,
              "n_survey" = n_survey,
              "MeshList_aniso" = MeshList_aniso
              ))
}
```
  
```{r preex-fm_load_data}
# run part1
survey_data_file <- system.file("original_data",
                                "Solea_solea",
                                "survey_data.Rdata",
                                package = "FishMap"
                                )

vmslogbook_data_file <- system.file("original_data",
                                "Solea_solea",
                                "vmslogbook_data.Rdata",
                                package = "FishMap"
                                )

study_domain_file <- system.file("original_data",
                                "Solea_solea",
                                "study_domain.Rdata",
                                package = "FishMap"
                                )

fm_data_inputs <- fm_load_data(species = "Solea_solea",
                         fleet = c("OTB_DEF_>=70_0","OTB_CEP_>=70_0","OTT_DEF_>=70_0"),
                         fitted_data = "biomass",
                         survey_data_file = survey_data_file,
                         vmslogbook_data_file = vmslogbook_data_file,
                         study_domain_file = study_domain_file,
                         year_start = 2018,
                         year_end = 2018,
                         month_start = 11,
                         month_end = 11,
                         time_step = "Month",
                         k = 0.25,
                         grid_xmin = -6,
                         grid_xmax = 0,
                         grid_ymin = 42,
                         grid_ymax = 48)
```
  
```{r tests-fm_load_data}
test_that("fm_load_data works", {
  # Check `fm_load_data` input values
  
  #' @description Testing the inputs of `fm_load_data` are correct
  expect_error(object = fm_load_data(fitted_data = "notagoodinput"),
               regexp = "'arg' should be one of .biomass., .presabs.")
  expect_error(object = fm_load_data(time_step = "notagoodinput"),
               regexp = "'arg' should be one of .Month., .Quarter.")
  
  
  # The test are done by default with k = 0.25, which allow the use of small size objects
  
  if (Sys.getenv("FISHMAP_K_PARAM") != "") {
    k <- as.numeric(Sys.getenv("FISHMAP_K_PARAM"))
  } else{
    k <- 0.25
  }
  
  # run part1
  survey_data_file <- system.file("original_data",
                                  "Solea_solea",
                                  "survey_data.Rdata",
                                  package = "FishMap"
  )
  
  vmslogbook_data_file <- system.file("original_data",
                                      "Solea_solea",
                                      "vmslogbook_data.Rdata",
                                      package = "FishMap"
  )
  
  study_domain_file <- system.file("original_data",
                                   "Solea_solea",
                                   "study_domain.Rdata",
                                   package = "FishMap"
  )
  
  fm_data_inputs <- fm_load_data(species = "Solea_solea",
                                 fleet = c("OTB_DEF_>=70_0","OTB_CEP_>=70_0","OTT_DEF_>=70_0"),
                                 fitted_data = "biomass",
                                 survey_data_file = survey_data_file,
                                 vmslogbook_data_file = vmslogbook_data_file,
                                 study_domain_file = study_domain_file,
                                 year_start = 2018,
                                 year_end = 2018,
                                 month_start = 11,
                                 month_end = 11,
                                 time_step = "Month",
                                 k = k,
                                 grid_xmin = -6,
                                 grid_xmax = 0,
                                 grid_ymin = 42,
                                 grid_ymax = 48)
  
  # save part1 outputs, one for each k tested
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    # setup save dir, create it if necessary
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    if (isFALSE(dir.exists(output_dir))) {
      dir.create(output_dir)
    }
    # save output
    readr::write_rds(x = fm_data_inputs,
                     file = file.path(output_dir, paste0("part1_output", k , ".rds")))
  }
  
  # check output is saved as rds
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    
    #' @description Test to check if we can save output
    expect_true(file.exists(file.path(
      output_dir, paste0("part1_output", k , ".rds")
    )))
  }
  
  # Check `fm_load_data` output values
  
  #' @description Testing the result of `fm_load_data` is a list
  expect_type(object = fm_data_inputs,  "list")
  
  #' @description Testing names of the list return by `fm_load_data`
  expect_named(
    object = fm_data_inputs,
    expected = c(
      "species",
      "b_com_i",
      "mesh",
      "time.step_df",
      "loc_x",
      "y_com_i",
      "y_sci_i",
      "cov_x_com",
      "cov_x_sci",
      "c_com_x",
      "t_com_i",
      "t_sci_i",
      "spde",
      "Aix_ij_com",
      "Aix_w_com",
      "Aix_ij_sci",
      "Aix_w_sci",
      "cov_x_pred",
      "Aix_ij_pred",
      "Aix_w_pred",
      "W",
      "n_survey",
      "MeshList_aniso"
    )
  )
  
  #' @description Testing types inside the list returned by `fm_load_data`
  expect_type(fm_data_inputs[["species"]], "character")
  expect_type(fm_data_inputs[["b_com_i"]], "double")
  expect_s3_class(fm_data_inputs[["mesh"]], "inla.mesh")
  expect_s3_class(fm_data_inputs[["time.step_df"]], "data.frame")
  expect_s3_class(fm_data_inputs[["loc_x"]], "data.frame")
  expect_type(fm_data_inputs[["y_com_i"]], "double")
  expect_type(fm_data_inputs[["y_sci_i"]], "double")
  expect_true(is.matrix(fm_data_inputs[["cov_x_com"]]))
  expect_true(is.matrix(fm_data_inputs[["cov_x_sci"]]))
  expect_true(is.array(fm_data_inputs[["c_com_x"]]))
  expect_type(fm_data_inputs[["t_com_i"]], "integer")
  expect_type(fm_data_inputs[["t_sci_i"]], "integer")
  expect_type(fm_data_inputs[["spde"]], "list")
  expect_true(is.matrix(fm_data_inputs[["Aix_ij_com"]]))
  expect_type(fm_data_inputs[["Aix_w_com"]], "double")
  expect_true(is.matrix(fm_data_inputs[["Aix_ij_sci"]]))
  expect_type(fm_data_inputs[["Aix_w_sci"]], "double")
  expect_true(is.matrix(fm_data_inputs[["cov_x_pred"]]))
  expect_true(is.matrix(fm_data_inputs[["Aix_ij_pred"]]))
  expect_type(fm_data_inputs[["Aix_w_pred"]], "double")
  expect_type(fm_data_inputs[["W"]], "double")
  expect_type(fm_data_inputs[["n_survey"]], "double")
  expect_type(fm_data_inputs[["MeshList_aniso"]], "list")
  
  # retrieve tmp name of mesh dir, which changes for each execution
  mesh_dir <- dirname(path = fm_data_inputs$mesh$meta$prefix)
  mesh_aniso_dir <- dirname(path = fm_data_inputs$MeshList_aniso$anisotropic_spde$mesh$meta$prefix)
  
  #' @description Testing that tmpdir of the mesh exists
  expect_true(dir.exists(mesh_dir))
  expect_true(dir.exists(mesh_aniso_dir))
  
  # Load previous run saved in testdir
  # to change this file, follow dev/0-dev_history.Rmd instructions
  expected_output <-
    readr::read_rds(file.path(paste0("part1_output", k , ".rds")))
  
  # homogenize tmp dir value tested in above test
  expected_output$mesh$meta$prefix <-
    fm_data_inputs$mesh$meta$prefix
  expected_output$MeshList_aniso$anisotropic_spde$mesh$meta$prefix <-
    fm_data_inputs$MeshList_aniso$anisotropic_spde$mesh$meta$prefix
  
  # sort list and data frame elements to avoid order discrepancies
  resort_all <- function(x) {
    x <- x[sort(names(x))]
    
    result <- lapply(x, function(x) {
      if (inherits(x, c("data.frame", 'list'))) {
        x[sort(names(x))]
      } else{
        x
      }
    })
    
    result
  }
  resorted_result <- resort_all(fm_data_inputs)
  resorted_expected <- resort_all(expected_output)
  
  # remove name attributes (likely generated by a specific version of {sf})
  attr(resorted_result$loc_x$long, which = "names") <- NULL
  attr(resorted_result$loc_x$lati, which = "names") <- NULL
  attr(resorted_expected$loc_x$long, which = "names") <- NULL
  attr(resorted_expected$loc_x$lati, which = "names") <- NULL
  
  #' @description Testing that the result of `fm_load_data` is stable
  expect_equal(object = resorted_result,
               expected = resorted_expected)
  
})
```

## part2: fit model

### `fm_fit_model()`: compile model and fit to data

This function will fit the model to the observation data. It will compile the model cpp file. It will fit the model to the input data generated from `fm_load_data()` and provide the results as a named list.

  
```{r preex-fm_fit_model}
# run part 2
fm_model_results <- fm_fit_model(fm_data_inputs = fm_data_inputs,
                                 SE = 1,
                                 data_source = 1,
                                 data_obs = 2,
                                 samp_process = 0,
                                 b_constraint = 2,
                                 cov_samp_process = 0,
                                 biomass_temporal = 1,
                                 sampling_temporal = 0,
                                 lf_link = 0,
                                 ref_data = "com",
                                 EM = "est_b",
                                 month_ref = 1)
```


## part3: generate output graphs

### `fm_generate_graphs()` : generate output graphs

This function will generate graphs of the model predictions. It will use as input the data generated from `fm_fit_model()` and provide the predictive plot within a named list. Is the sampling process is activated (`samp_process = 1`), an additionnal graphic for eta result will be generated.

```{r function-fm_generate_graphs}
#' generate output graphs
#' 
#' @param fm_model_results list Named list obtained from `fm_fit_model()`
#' 
#' @importFrom dplyr mutate inner_join
#' @importFrom ggplot2 ggplot geom_sf aes scale_color_distiller facet_wrap
#' @importFrom sf st_as_sf
#' @importFrom stringr str_replace
#' @importFrom tictoc tic toc
#' @importFrom tidyr pivot_longer starts_with
#' @importFrom rgdal projInfo
#' 
#' @return list A named list of all generated graphs (step 3)
#' 
#' @export
fm_generate_graphs <- function(fm_model_results) {
  ## Plot model outputs
  #--------------------
  message("Running step 4 -plot graphs-")
  tic("Step 4 -plot graphs-")
  
  ## Dependencies from Part1 factorization
  loc_x <- fm_model_results[["loc_x"]]
  time.step_df <- fm_model_results[["time.step_df"]]
  report <- fm_model_results[["report"]]
  samp_process <- fm_model_results[["samp_process"]]
  
  if (nrow(time.step_df) > 1) {
    pred_df <-
      cbind(loc_x[, c("long", "lati")], S_x = report$S_p[1:nrow(loc_x), ]) %>%
      pivot_longer(cols = starts_with("S_x."),
                   names_to = "t",
                   values_to = "S_x") %>%
      mutate(t = as.numeric(str_replace(t, "S_x.", ""))) %>%
      inner_join(time.step_df)
    
    pred_sf <- st_as_sf(pred_df, coords = c("long", "lati"))
    
    pred_plot <- ggplot(pred_sf) +
      geom_sf(aes(col = S_x)) +
      scale_color_distiller(palette = "Spectral") +
      facet_wrap(. ~ Year_Month)
    
    
  } else if (nrow(time.step_df) == 1) {
    pred_df <-
      cbind(loc_x[, c("long", "lati")], S_x = report$S_p[1:nrow(loc_x), ])
    
    pred_sf <- st_as_sf(pred_df, coords = c("long", "lati"))
    
    pred_plot <- ggplot(pred_sf) +
      geom_sf(aes(col = S_x)) +
      scale_color_distiller(palette = "Spectral")
    
  }
  
  plot(pred_plot)
  
  # plot eta if sampling is active
  if (samp_process == 1) {
    for (i in 1:3) {
      eta_df <-
        cbind(loc_x[, c("long", "lati")], eta = report$lambda_p[1:nrow(loc_x), , i]) %>%
        pivot_longer(
          cols = starts_with("eta."),
          names_to = "t",
          values_to = "eta"
        ) %>%
        mutate(t = as.numeric(str_replace(t, "eta.", ""))) %>%
        inner_join(time.step_df)
      
      eta_sf <- st_as_sf(eta_df, coords = c("long", "lati"))
      
      eta_plot <- ggplot(eta_sf) +
        geom_sf(aes(col = log(eta))) +
        scale_color_distiller(palette = "Spectral") +
        facet_wrap(. ~ Year_Month)
      
      plot(eta_plot)
    }
  }
  
  # finished step 4 -plot graph-
  toc()
  
  # return outputs as named list
  output_list <- list("pred_plot" = pred_plot)
  
  # return eta plot if sampling is on
  if (samp_process == 1) {
    output_list[["eta_plot"]] <- eta_plot
  }
  return(output_list)
  
}
```
  
```{r preex-fm_generate_graphs}
# run part 3
fm_generate_graphs(fm_model_results)
```
  
```{r tests-fm_generate_graphs}
test_that("fm_generate_graphs works", {
  
  test_resolution <- Sys.getenv("FISHMAP_TEST_RESOLUTION", unset = "small")
  
  # # run part1
  # fm_data_inputs <- fm_load_data()
  
  # run part2
  if(test_resolution == "small"){
    
    
    fm_model_results <- readr::read_rds(
      system.file(
        "examples",
        paste0("part2_output_", test_resolution , ".rds"),
        package = "FishMap")
    )
  }else if (test_resolution == "big"){
    # TODO add tests for high resolution
  }
  
  # run part3
  fm_graph_results <- fm_generate_graphs(fm_model_results)
  
  # save part3 outputs
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    # setup save dir, create it if necessary
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    if (isFALSE(dir.exists(output_dir))){
      dir.create(output_dir)
    }
    # save output
    saveRDS(object = fm_graph_results, file = file.path(output_dir, "part3_output.rds"))
  }
  
  # check output is a list
  expect_true(object = inherits(x = fm_graph_results,
                                what = "list"))
  
  # check pred_plot output is a ggplot object
  expect_equal(object = class(fm_graph_results[["pred_plot"]]),
               expected = c("gg", "ggplot"))
  
  # check output is saved as rds
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    expect_true(file.exists(file.path(output_dir, "part3_output.rds")))
  }
  
})
```


```{r tests-complete_pipeline}
test_that("Main functions work together", {
  
  # Set up params for the model
  
  # run part1
  survey_data_file <- system.file("original_data",
                                  "Solea_solea",
                                  "survey_data.Rdata",
                                  package = "FishMap"
  )
  
  vmslogbook_data_file <- system.file("original_data",
                                      "Solea_solea",
                                      "vmslogbook_data.Rdata",
                                      package = "FishMap"
  )
  
  study_domain_file <- system.file("original_data",
                                   "Solea_solea",
                                   "study_domain.Rdata",
                                   package = "FishMap"
  )
  
  fm_data_inputs <- fm_load_data(species = "Solea_solea",
                                 fleet = c("OTB_DEF_>=70_0","OTB_CEP_>=70_0","OTT_DEF_>=70_0"),
                                 fitted_data = "biomass",
                                 survey_data_file = survey_data_file,
                                 vmslogbook_data_file = vmslogbook_data_file,
                                 study_domain_file = study_domain_file,
                                 year_start = 2018,
                                 year_end = 2018,
                                 month_start = 11,
                                 month_end = 11,
                                 time_step = "Month",
                                 k = 0.25,
                                 grid_xmin = -6,
                                 grid_xmax = 0,
                                 grid_ymin = 42,
                                 grid_ymax = 48)
  
  
  #'@description Testing that fm_data_inputs return a named list for the next function
  test_list <- is.list(fm_data_inputs)
  test_name <- length(names(fm_data_inputs)) != 0 
  
  expect_true(test_list & test_name)
  
  #'@descripton Testing if `fm_fit_model` always work
  result_fit_model <- try(
    fm_fit_model(fm_data_inputs = fm_data_inputs,
                 SE = 1,
                 data_source = 1,
                 data_obs = 2,
                 samp_process = 0,
                 b_constraint = 2,
                 cov_samp_process = 0,
                 biomass_temporal = 1,
                 sampling_temporal = 0,
                 lf_link = 0,
                 ref_data = "com",
                 EM = "est_b",
                 month_ref = 1), 
    silent = TRUE)
  
  expect_true(
               !inherits(result_fit_model, "try-error"), 
               label = "`fm_fit_model` generate a error. Please check the core function or the returned objet of `fm_load_data`. Running function"
  )
  
  
  #'@descripton Testing if `fm_fit_model` always work
  result_graph <- try(fm_generate_graphs(result_fit_model), silent = TRUE)
  
  expect_true(
               !inherits(result_graph, "try-error"), 
               label = "`fm_generate_graphs` generate a error. Please check the core function or the returned objet of `fm_fit_model`. Running function"
  )
  
  #'@description testing output of `fm_generate_graphs`
  expect_type(result_graph, "list")
  expect_s3_class(result_graph[["pred_plot"]], "ggplot")
  
})
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_main.Rmd", check = FALSE,
               vignette_name = "user - running fishmap")
# To perform check, please go to `dev/0_dev_history.Rmd` and run the section `Use everytime needed`
```

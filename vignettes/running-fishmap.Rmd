---
title: "running fishmap"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{running-fishmap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(FishMap)
```

<!-- WARNING - This vignette is generated by {fusen} from /dev/flat_main.Rmd: do not edit by hand -->

```{r message = FALSE}
library(dplyr)
library(INLA)
library(ggplot2)
library(sf)
library(stringr)
library(tidyr)
library(TMB)
library(tictoc)
library(testthat)
```

# `main.R`

This vignette runs a toy example of the FishMap spatio-temporal model. The execution comprises three steps : data preparation, model fitting and graph generation.


## part1: Data preparation

### `fm_load_data()` : prepare and load model inputs

This function Prepare all the necessary output for the model fitting. It will filter and shape the observation data (VMS and scientific). It will generate the spatial mesh for the study domain. All outputs are reported as part of a named list.
    

  

```{r preex-fm_load_data}
# run part1
fm_data_inputs <- fm_load_data()

```

  

## part2: fit model

### `fm_fit_model()`: compile model and fit to data

This function will fit the model to the observation data. It will compile the model cpp file. It will fit the model to the input data generated from `fm_load_data()` and provide the results as a named list.

    

  

```{r preex-fm_fit_model}
# run part 2
fm_model_results <- fm_fit_model(fm_data_inputs)
```

  

## part3: generate output graphs

```{r}
## Plot model outputs
#--------------------
message("Running step 4 -plot graphs-")
tic("Step 4 -plot graphs-")

## Dependencies from Part1 factorization
loc_x <- fm_model_results[["loc_x"]]
time.step_df <- fm_model_results[["time.step_df"]]
report <- fm_model_results[["report"]]
samp_process <- fm_model_results[["samp_process"]]

if(nrow(time.step_df)>1){

  pred_df <- cbind(loc_x[,c("long","lati")],S_x=report$S_p[1:nrow(loc_x),]) %>%
    pivot_longer(cols = starts_with("S_x."),names_to = "t", values_to = "S_x") %>%
    mutate(t = as.numeric(str_replace(t,"S_x.",""))) %>%
    inner_join(time.step_df)

  pred_sf <- st_as_sf(pred_df,coords = c("long","lati"))

  pred_plot <- ggplot(pred_sf)+
    geom_sf(aes(col=S_x))+
    scale_color_distiller(palette = "Spectral")+
    facet_wrap(.~Year_Month)


}else if(nrow(time.step_df)==1){

  pred_df <- cbind(loc_x[,c("long","lati")],S_x=report$S_p[1:nrow(loc_x),])

  pred_sf <- st_as_sf(pred_df,coords = c("long","lati"))

  pred_plot <- ggplot(pred_sf)+
    geom_sf(aes(col=S_x))+
    scale_color_distiller(palette = "Spectral")

}

plot(pred_plot)

# plot eta if sampling is active
if (samp_process == 1){
  for(i in 1:3){
    eta_df <- cbind(loc_x[,c("long","lati")],eta=report$lambda_p[1:nrow(loc_x),,i]) %>%
      pivot_longer(cols = starts_with("eta."),names_to = "t", values_to = "eta") %>%
      mutate(t = as.numeric(str_replace(t,"eta.",""))) %>%
      inner_join(time.step_df)

    eta_sf <- st_as_sf(eta_df,coords = c("long","lati"))

    eta_plot <- ggplot(eta_sf)+
      geom_sf(aes(col=log(eta)))+
      scale_color_distiller(palette = "Spectral")+
      facet_wrap(.~Year_Month)

    plot(eta_plot)
  }
}

# finished step 4 -plot graph-
toc()
```


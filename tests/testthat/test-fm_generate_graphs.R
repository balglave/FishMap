# WARNING - Generated by {fusen} from /dev/flat_main.Rmd: do not edit by hand

test_that("fm_generate_graphs works", {
  
  test_resolution <- Sys.getenv("FISHMAP_TEST_RESOLUTION", unset = "small")
  
  # # run part1
  # fm_data_inputs <- fm_load_data()
  
  # run part2
  if(test_resolution == "small"){
    
    
    fm_model_results <- readr::read_rds(
      system.file(
        "examples",
        paste0("part2_output_", test_resolution , ".rds"),
        package = "FishMap")
    )
  }else if (test_resolution == "big"){
    # TODO add tests for high resolution
  }
  
  # run part3
  fm_graph_results <- fm_generate_graphs(fm_model_results)
  
  # save part3 outputs
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    # setup save dir, create it if necessary
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    if (isFALSE(dir.exists(output_dir))){
      dir.create(output_dir)
    }
    # save output
    saveRDS(object = fm_model_results, file = file.path(output_dir, "part3_output.rds"))
  }
  
  # check output is a list
  expect_true(object = inherits(x = fm_model_results,
                                what = "list"))
  
  # check pred_plot output is a ggplot object
  expect_equal(object = class(fm_graph_results[["pred_plot"]]),
               expected = c("gg", "ggplot"))
  
  # check output is saved as rds
  if (Sys.getenv("FISHMAP_UPDATE_OUTPUTS") == "TRUE") {
    output_dir <- Sys.getenv("FISHMAP_OUTPUT_DIR")
    expect_true(file.exists(file.path(output_dir, "part3_output.rds")))
  }
  
})

test_that("Main functions work together", {
  
  # Set up params for the model
  
  
  fm_data_inputs <- fm_load_data(k = 0.25, month_start = 11, month_end = 11)
  
  #'@description Testing that fm_data_inputs return a named list for the next function
  test_list <- is.list(fm_data_inputs)
  test_name <- length(names(fm_data_inputs)) != 0 
  
  expect_true(test_list & test_name)
  
  #'@descripton Testing if `fm_fit_model` always work
  result_fit_model <- try(fm_fit_model(fm_data_inputs), silent = TRUE)
  
  expect_true(
               !inherits(result_fit_model, "try-error"), 
               label = "`fm_fit_model` generate a error. Please check the core function or the returned objet of `fm_load_data`. Running function"
  )
  
  
  #'@descripton Testing if `fm_fit_model` always work
  result_graph <- try(fm_generate_graphs(result_fit_model), silent = TRUE)
  
  expect_true(
               !inherits(result_graph, "try-error"), 
               label = "`fm_generate_graphs` generate a error. Please check the core function or the returned objet of `fm_fit_model`. Running function"
  )
  
  #'@description testing output of `fm_generate_graphs`
  expect_type(result_graph, "list")
  expect_s3_class(result_graph[["pred_plot"]], "ggplot")
  
})
